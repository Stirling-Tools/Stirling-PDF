<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CustomLogoutSuccessHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Stirling-PDF</a> &gt; <a href="index.source.html" class="el_package">stirling.software.SPDF.config.security</a> &gt; <span class="el_source">CustomLogoutSuccessHandler.java</span></div><h1>CustomLogoutSuccessHandler.java</h1><pre class="source lang-java linenums">package stirling.software.SPDF.config.security;

import java.io.IOException;
import java.security.cert.X509Certificate;
import java.security.interfaces.RSAPrivateKey;
import java.util.ArrayList;
import java.util.List;

import org.springframework.core.io.Resource;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.oauth2.client.authentication.OAuth2AuthenticationToken;
import org.springframework.security.saml2.provider.service.authentication.Saml2Authentication;
import org.springframework.security.web.authentication.logout.SimpleUrlLogoutSuccessHandler;

import com.coveo.saml.SamlClient;
import com.coveo.saml.SamlException;

import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

import lombok.AllArgsConstructor;
import lombok.extern.slf4j.Slf4j;

import stirling.software.SPDF.SPDFApplication;
import stirling.software.SPDF.config.security.saml2.CertificateUtils;
import stirling.software.SPDF.config.security.saml2.CustomSaml2AuthenticatedPrincipal;
import stirling.software.SPDF.model.ApplicationProperties;
import stirling.software.SPDF.model.ApplicationProperties.Security.OAUTH2;
import stirling.software.SPDF.model.ApplicationProperties.Security.SAML2;
import stirling.software.SPDF.model.provider.KeycloakProvider;
import stirling.software.SPDF.utils.UrlUtils;

<span class="nc" id="L34">@Slf4j</span>
@AllArgsConstructor
public class CustomLogoutSuccessHandler extends SimpleUrlLogoutSuccessHandler {

    public static final String LOGOUT_PATH = &quot;/login?logout=true&quot;;

    private final ApplicationProperties applicationProperties;

    @Override
    public void onLogoutSuccess(
            HttpServletRequest request, HttpServletResponse response, Authentication authentication)
            throws IOException {
<span class="nc bnc" id="L46" title="All 2 branches missed.">        if (!response.isCommitted()) {</span>
<span class="nc bnc" id="L47" title="All 2 branches missed.">            if (authentication != null) {</span>
<span class="nc bnc" id="L48" title="All 2 branches missed.">                if (authentication instanceof Saml2Authentication samlAuthentication) {</span>
                    // Handle SAML2 logout redirection
<span class="nc" id="L50">                    getRedirect_saml2(request, response, samlAuthentication);</span>
<span class="nc bnc" id="L51" title="All 2 branches missed.">                } else if (authentication instanceof OAuth2AuthenticationToken oAuthToken) {</span>
                    // Handle OAuth2 logout redirection
<span class="nc" id="L53">                    getRedirect_oauth2(request, response, oAuthToken);</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">                } else if (authentication instanceof UsernamePasswordAuthenticationToken) {</span>
                    // Handle Username/Password logout
<span class="nc" id="L56">                    getRedirectStrategy().sendRedirect(request, response, LOGOUT_PATH);</span>
                } else {
                    // Handle unknown authentication types
<span class="nc" id="L59">                    log.error(</span>
                            &quot;Authentication class unknown: {}&quot;,
<span class="nc" id="L61">                            authentication.getClass().getSimpleName());</span>
<span class="nc" id="L62">                    getRedirectStrategy().sendRedirect(request, response, LOGOUT_PATH);</span>
                }
            } else {
                // Redirect to login page after logout
<span class="nc" id="L66">                String path = checkForErrors(request);</span>
<span class="nc" id="L67">                getRedirectStrategy().sendRedirect(request, response, path);</span>
            }
        }
<span class="nc" id="L70">    }</span>

    // Redirect for SAML2 authentication logout
    private void getRedirect_saml2(
            HttpServletRequest request,
            HttpServletResponse response,
            Saml2Authentication samlAuthentication)
            throws IOException {

<span class="nc" id="L79">        SAML2 samlConf = applicationProperties.getSecurity().getSaml2();</span>
<span class="nc" id="L80">        String registrationId = samlConf.getRegistrationId();</span>

<span class="nc" id="L82">        CustomSaml2AuthenticatedPrincipal principal =</span>
<span class="nc" id="L83">                (CustomSaml2AuthenticatedPrincipal) samlAuthentication.getPrincipal();</span>

<span class="nc" id="L85">        String nameIdValue = principal.name();</span>

        try {
            // Read certificate from the resource
<span class="nc" id="L89">            Resource certificateResource = samlConf.getSpCert();</span>
<span class="nc" id="L90">            X509Certificate certificate = CertificateUtils.readCertificate(certificateResource);</span>

<span class="nc" id="L92">            List&lt;X509Certificate&gt; certificates = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L93">            certificates.add(certificate);</span>

            // Construct URLs required for SAML configuration
<span class="nc" id="L96">            SamlClient samlClient = getSamlClient(registrationId, samlConf, certificates);</span>

            // Read private key for service provider
<span class="nc" id="L99">            Resource privateKeyResource = samlConf.getPrivateKey();</span>
<span class="nc" id="L100">            RSAPrivateKey privateKey = CertificateUtils.readPrivateKey(privateKeyResource);</span>

            // Set service provider keys for the SamlClient
<span class="nc" id="L103">            samlClient.setSPKeys(certificate, privateKey);</span>

            // Redirect to identity provider for logout
<span class="nc" id="L106">            samlClient.redirectToIdentityProvider(response, null, nameIdValue);</span>
<span class="nc" id="L107">        } catch (Exception e) {</span>
<span class="nc" id="L108">            log.error(</span>
                    &quot;Error retrieving logout URL from Provider {} for user {}&quot;,
<span class="nc" id="L110">                    samlConf.getProvider(),</span>
                    nameIdValue,
                    e);
<span class="nc" id="L113">            getRedirectStrategy().sendRedirect(request, response, LOGOUT_PATH);</span>
<span class="nc" id="L114">        }</span>
<span class="nc" id="L115">    }</span>

    // Redirect for OAuth2 authentication logout
    private void getRedirect_oauth2(
            HttpServletRequest request,
            HttpServletResponse response,
            OAuth2AuthenticationToken oAuthToken)
            throws IOException {
        String registrationId;
<span class="nc" id="L124">        OAUTH2 oauth = applicationProperties.getSecurity().getOauth2();</span>
<span class="nc" id="L125">        String path = checkForErrors(request);</span>

<span class="nc" id="L127">        String redirectUrl = UrlUtils.getOrigin(request) + &quot;/login?&quot; + path;</span>
<span class="nc" id="L128">        registrationId = oAuthToken.getAuthorizedClientRegistrationId();</span>

        // Redirect based on OAuth2 provider
<span class="nc bnc" id="L131" title="All 3 branches missed.">        switch (registrationId.toLowerCase()) {</span>
            case &quot;keycloak&quot; -&gt; {
<span class="nc" id="L133">                KeycloakProvider keycloak = oauth.getClient().getKeycloak();</span>

<span class="nc bnc" id="L135" title="All 2 branches missed.">                boolean isKeycloak = !keycloak.getIssuer().isBlank();</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">                boolean isCustomOAuth = !oauth.getIssuer().isBlank();</span>

<span class="nc" id="L138">                String logoutUrl = redirectUrl;</span>

<span class="nc bnc" id="L140" title="All 2 branches missed.">                if (isKeycloak) {</span>
<span class="nc" id="L141">                    logoutUrl = keycloak.getIssuer();</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">                } else if (isCustomOAuth) {</span>
<span class="nc" id="L143">                    logoutUrl = oauth.getIssuer();</span>
                }
<span class="nc bnc" id="L145" title="All 4 branches missed.">                if (isKeycloak || isCustomOAuth) {</span>
<span class="nc" id="L146">                    logoutUrl +=</span>
                            &quot;/protocol/openid-connect/logout&quot;
                                    + &quot;?client_id=&quot;
<span class="nc" id="L149">                                    + oauth.getClientId()</span>
                                    + &quot;&amp;post_logout_redirect_uri=&quot;
<span class="nc" id="L151">                                    + response.encodeRedirectURL(redirectUrl);</span>
<span class="nc" id="L152">                    log.info(&quot;Redirecting to Keycloak logout URL: {}&quot;, logoutUrl);</span>
                } else {
<span class="nc" id="L154">                    log.info(</span>
                            &quot;No redirect URL for {} available. Redirecting to default logout URL: {}&quot;,
                            registrationId,
                            logoutUrl);
                }
<span class="nc" id="L159">                response.sendRedirect(logoutUrl);</span>
<span class="nc" id="L160">            }</span>
            case &quot;github&quot;, &quot;google&quot; -&gt; {
<span class="nc" id="L162">                log.info(</span>
                        &quot;No redirect URL for {} available. Redirecting to default logout URL: {}&quot;,
                        registrationId,
                        redirectUrl);
<span class="nc" id="L166">                response.sendRedirect(redirectUrl);</span>
<span class="nc" id="L167">            }</span>
            default -&gt; {
<span class="nc" id="L169">                log.info(&quot;Redirecting to default logout URL: {}&quot;, redirectUrl);</span>
<span class="nc" id="L170">                response.sendRedirect(redirectUrl);</span>
            }
        }
<span class="nc" id="L173">    }</span>

    private static SamlClient getSamlClient(
            String registrationId, SAML2 samlConf, List&lt;X509Certificate&gt; certificates)
            throws SamlException {
        String serverUrl =
<span class="nc" id="L179">                SPDFApplication.getStaticBaseUrl() + &quot;:&quot; + SPDFApplication.getStaticPort();</span>

<span class="nc" id="L181">        String relyingPartyIdentifier =</span>
                serverUrl + &quot;/saml2/service-provider-metadata/&quot; + registrationId;

<span class="nc" id="L184">        String assertionConsumerServiceUrl = serverUrl + &quot;/login/saml2/sso/&quot; + registrationId;</span>

<span class="nc" id="L186">        String idpSLOUrl = samlConf.getIdpSingleLogoutUrl();</span>

<span class="nc" id="L188">        String idpIssuer = samlConf.getIdpIssuer();</span>

        // Create SamlClient instance for SAML logout
<span class="nc" id="L191">        return new SamlClient(</span>
                relyingPartyIdentifier,
                assertionConsumerServiceUrl,
                idpSLOUrl,
                idpIssuer,
                certificates,
                SamlClient.SamlIdpBinding.POST);
    }

    /**
     * Handles different error scenarios during logout. Will return a &lt;code&gt;String&lt;/code&gt; containing
     * the error request parameter.
     *
     * @param request the user's &lt;code&gt;HttpServletRequest&lt;/code&gt; request.
     * @return a &lt;code&gt;String&lt;/code&gt; containing the error request parameter.
     */
    private String checkForErrors(HttpServletRequest request) {
        String errorMessage;
<span class="nc" id="L209">        String path = &quot;logout=true&quot;;</span>

<span class="nc bnc" id="L211" title="All 2 branches missed.">        if (request.getParameter(&quot;oAuth2AuthenticationErrorWeb&quot;) != null) {</span>
<span class="nc" id="L212">            path = &quot;errorOAuth=userAlreadyExistsWeb&quot;;</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">        } else if ((errorMessage = request.getParameter(&quot;errorOAuth&quot;)) != null) {</span>
<span class="nc" id="L214">            path = &quot;errorOAuth=&quot; + sanitizeInput(errorMessage);</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">        } else if (request.getParameter(&quot;oAuth2AutoCreateDisabled&quot;) != null) {</span>
<span class="nc" id="L216">            path = &quot;errorOAuth=oAuth2AutoCreateDisabled&quot;;</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">        } else if (request.getParameter(&quot;oAuth2AdminBlockedUser&quot;) != null) {</span>
<span class="nc" id="L218">            path = &quot;errorOAuth=oAuth2AdminBlockedUser&quot;;</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">        } else if (request.getParameter(&quot;userIsDisabled&quot;) != null) {</span>
<span class="nc" id="L220">            path = &quot;errorOAuth=userIsDisabled&quot;;</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">        } else if ((errorMessage = request.getParameter(&quot;error&quot;)) != null) {</span>
<span class="nc" id="L222">            path = &quot;errorOAuth=&quot; + sanitizeInput(errorMessage);</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">        } else if (request.getParameter(&quot;badCredentials&quot;) != null) {</span>
<span class="nc" id="L224">            path = &quot;errorOAuth=badCredentials&quot;;</span>
        }

<span class="nc" id="L227">        return path;</span>
    }

    /**
     * Sanitize input to avoid potential security vulnerabilities. Will return a sanitised &lt;code&gt;
     * String&lt;/code&gt;.
     *
     * @return a sanitised &lt;code&gt;String&lt;/code&gt;
     */
    private String sanitizeInput(String input) {
<span class="nc" id="L237">        return input.replaceAll(&quot;[^a-zA-Z0-9 ]&quot;, &quot;&quot;);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>