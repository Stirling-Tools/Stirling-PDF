<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SplitPdfBySizeController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Stirling-PDF</a> &gt; <a href="index.source.html" class="el_package">stirling.software.SPDF.controller.api</a> &gt; <span class="el_source">SplitPdfBySizeController.java</span></div><h1>SplitPdfBySizeController.java</h1><pre class="source lang-java linenums">package stirling.software.SPDF.controller.api;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.zip.ZipEntry;
import java.util.zip.ZipOutputStream;

import org.apache.pdfbox.pdmodel.PDDocument;
import org.apache.pdfbox.pdmodel.PDPage;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

import io.github.pixee.security.Filenames;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;

import lombok.extern.slf4j.Slf4j;

import stirling.software.SPDF.model.api.general.SplitPdfBySizeOrCountRequest;
import stirling.software.SPDF.service.CustomPDFDocumentFactory;
import stirling.software.SPDF.utils.GeneralUtils;
import stirling.software.SPDF.utils.WebResponseUtils;

@RestController
@RequestMapping(&quot;/api/v1/general&quot;)
<span class="nc" id="L34">@Slf4j</span>
@Tag(name = &quot;General&quot;, description = &quot;General APIs&quot;)
public class SplitPdfBySizeController {

    private final CustomPDFDocumentFactory pdfDocumentFactory;

    @Autowired
<span class="nc" id="L41">    public SplitPdfBySizeController(CustomPDFDocumentFactory pdfDocumentFactory) {</span>
<span class="nc" id="L42">        this.pdfDocumentFactory = pdfDocumentFactory;</span>
<span class="nc" id="L43">    }</span>

    @PostMapping(value = &quot;/split-by-size-or-count&quot;, consumes = &quot;multipart/form-data&quot;)
    @Operation(
            summary = &quot;Auto split PDF pages into separate documents based on size or count&quot;,
            description =
                    &quot;split PDF into multiple paged documents based on size/count, ie if 20 pages&quot;
                            + &quot; and split into 5, it does 5 documents each 4 pages\r\n&quot;
                            + &quot; if 10MB and each page is 1MB and you enter 2MB then 5 docs each 2MB&quot;
                            + &quot; (rounded so that it accepts 1.9MB but not 2.1MB) Input:PDF&quot;
                            + &quot; Output:ZIP-PDF Type:SISO&quot;)
    public ResponseEntity&lt;byte[]&gt; autoSplitPdf(@ModelAttribute SplitPdfBySizeOrCountRequest request)
            throws Exception {

<span class="nc" id="L57">        log.debug(&quot;Starting PDF split process with request: {}&quot;, request);</span>
<span class="nc" id="L58">        MultipartFile file = request.getFileInput();</span>

<span class="nc" id="L60">        Path zipFile = Files.createTempFile(&quot;split_documents&quot;, &quot;.zip&quot;);</span>
<span class="nc" id="L61">        log.debug(&quot;Created temporary zip file: {}&quot;, zipFile);</span>

<span class="nc" id="L63">        String filename =</span>
<span class="nc" id="L64">                Filenames.toSimpleFileName(file.getOriginalFilename())</span>
<span class="nc" id="L65">                        .replaceFirst(&quot;[.][^.]+$&quot;, &quot;&quot;);</span>
<span class="nc" id="L66">        log.debug(&quot;Base filename for output: {}&quot;, filename);</span>

<span class="nc" id="L68">        byte[] data = null;</span>
        try {
<span class="nc" id="L70">            log.debug(&quot;Reading input file bytes&quot;);</span>
<span class="nc" id="L71">            byte[] pdfBytes = file.getBytes();</span>
<span class="nc" id="L72">            log.debug(&quot;Successfully read {} bytes from input file&quot;, pdfBytes.length);</span>

<span class="nc" id="L74">            log.debug(&quot;Creating ZIP output stream&quot;);</span>
<span class="nc" id="L75">            try (ZipOutputStream zipOut = new ZipOutputStream(Files.newOutputStream(zipFile))) {</span>
<span class="nc" id="L76">                log.debug(&quot;Loading PDF document&quot;);</span>
<span class="nc" id="L77">                try (PDDocument sourceDocument = pdfDocumentFactory.load(pdfBytes)) {</span>
<span class="nc" id="L78">                    log.debug(</span>
                            &quot;Successfully loaded PDF with {} pages&quot;,
<span class="nc" id="L80">                            sourceDocument.getNumberOfPages());</span>

<span class="nc" id="L82">                    int type = request.getSplitType();</span>
<span class="nc" id="L83">                    String value = request.getSplitValue();</span>
<span class="nc" id="L84">                    log.debug(&quot;Split type: {}, Split value: {}&quot;, type, value);</span>

<span class="nc bnc" id="L86" title="All 2 branches missed.">                    if (type == 0) {</span>
<span class="nc" id="L87">                        log.debug(&quot;Processing split by size&quot;);</span>
<span class="nc" id="L88">                        long maxBytes = GeneralUtils.convertSizeToBytes(value);</span>
<span class="nc" id="L89">                        log.debug(&quot;Max bytes per document: {}&quot;, maxBytes);</span>
<span class="nc" id="L90">                        handleSplitBySize(sourceDocument, maxBytes, zipOut, filename);</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">                    } else if (type == 1) {</span>
<span class="nc" id="L92">                        log.debug(&quot;Processing split by page count&quot;);</span>
<span class="nc" id="L93">                        int pageCount = Integer.parseInt(value);</span>
<span class="nc" id="L94">                        log.debug(&quot;Pages per document: {}&quot;, pageCount);</span>
<span class="nc" id="L95">                        handleSplitByPageCount(sourceDocument, pageCount, zipOut, filename);</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">                    } else if (type == 2) {</span>
<span class="nc" id="L97">                        log.debug(&quot;Processing split by document count&quot;);</span>
<span class="nc" id="L98">                        int documentCount = Integer.parseInt(value);</span>
<span class="nc" id="L99">                        log.debug(&quot;Total number of documents: {}&quot;, documentCount);</span>
<span class="nc" id="L100">                        handleSplitByDocCount(sourceDocument, documentCount, zipOut, filename);</span>
<span class="nc" id="L101">                    } else {</span>
<span class="nc" id="L102">                        log.error(&quot;Invalid split type: {}&quot;, type);</span>
<span class="nc" id="L103">                        throw new IllegalArgumentException(</span>
                                &quot;Invalid argument for split type: &quot; + type);
                    }

<span class="nc" id="L107">                    log.debug(&quot;PDF splitting completed successfully&quot;);</span>
<span class="nc" id="L108">                } catch (Exception e) {</span>
<span class="nc" id="L109">                    log.error(&quot;Error loading or processing PDF document&quot;, e);</span>
<span class="nc" id="L110">                    throw e;</span>
<span class="nc" id="L111">                }</span>
<span class="nc" id="L112">            } catch (IOException e) {</span>
<span class="nc" id="L113">                log.error(&quot;Error creating or writing to ZIP file&quot;, e);</span>
<span class="nc" id="L114">                throw e;</span>
<span class="nc" id="L115">            }</span>

<span class="nc" id="L117">        } catch (Exception e) {</span>
<span class="nc" id="L118">            log.error(&quot;Exception during PDF splitting process&quot;, e);</span>
<span class="nc" id="L119">            throw e; // Re-throw to ensure proper error response</span>
        } finally {
            try {
<span class="nc" id="L122">                log.debug(&quot;Reading ZIP file data&quot;);</span>
<span class="nc" id="L123">                data = Files.readAllBytes(zipFile);</span>
<span class="nc" id="L124">                log.debug(&quot;Successfully read {} bytes from ZIP file&quot;, data.length);</span>
<span class="nc" id="L125">            } catch (IOException e) {</span>
<span class="nc" id="L126">                log.error(&quot;Error reading ZIP file data&quot;, e);</span>
<span class="nc" id="L127">            }</span>

            try {
<span class="nc" id="L130">                log.debug(&quot;Deleting temporary ZIP file&quot;);</span>
<span class="nc" id="L131">                boolean deleted = Files.deleteIfExists(zipFile);</span>
<span class="nc" id="L132">                log.debug(&quot;Temporary ZIP file deleted: {}&quot;, deleted);</span>
<span class="nc" id="L133">            } catch (IOException e) {</span>
<span class="nc" id="L134">                log.error(&quot;Error deleting temporary ZIP file&quot;, e);</span>
<span class="nc" id="L135">            }</span>
        }

<span class="nc bnc" id="L138" title="All 2 branches missed.">        log.debug(&quot;Returning response with {} bytes of data&quot;, data != null ? data.length : 0);</span>
<span class="nc" id="L139">        return WebResponseUtils.bytesToWebResponse(</span>
                data, filename + &quot;.zip&quot;, MediaType.APPLICATION_OCTET_STREAM);
    }

    private void handleSplitBySize(
            PDDocument sourceDocument, long maxBytes, ZipOutputStream zipOut, String baseFilename)
            throws IOException {
<span class="nc" id="L146">        log.debug(&quot;Starting handleSplitBySize with maxBytes={}&quot;, maxBytes);</span>

<span class="nc" id="L148">        PDDocument currentDoc =</span>
<span class="nc" id="L149">                pdfDocumentFactory.createNewDocumentBasedOnOldDocument(sourceDocument);</span>
<span class="nc" id="L150">        int fileIndex = 1;</span>
<span class="nc" id="L151">        int totalPages = sourceDocument.getNumberOfPages();</span>
<span class="nc" id="L152">        int pageAdded = 0;</span>

        // Smart size check frequency - check more often with larger documents
<span class="nc" id="L155">        int baseCheckFrequency = 5;</span>

<span class="nc bnc" id="L157" title="All 2 branches missed.">        for (int pageIndex = 0; pageIndex &lt; totalPages; pageIndex++) {</span>
<span class="nc" id="L158">            PDPage page = sourceDocument.getPage(pageIndex);</span>
<span class="nc" id="L159">            log.debug(&quot;Processing page {} of {}&quot;, pageIndex + 1, totalPages);</span>

            // Add the page to current document
<span class="nc" id="L162">            PDPage newPage = new PDPage(page.getCOSObject());</span>
<span class="nc" id="L163">            currentDoc.addPage(newPage);</span>
<span class="nc" id="L164">            pageAdded++;</span>

            // Dynamic size checking based on document size and page count
<span class="nc bnc" id="L167" title="All 6 branches missed.">            boolean shouldCheckSize =</span>
                    (pageAdded % baseCheckFrequency == 0)
                            || (pageIndex == totalPages - 1)
                            || (pageAdded &gt;= 20); // Always check after 20 pages

<span class="nc bnc" id="L172" title="All 2 branches missed.">            if (shouldCheckSize) {</span>
<span class="nc" id="L173">                log.debug(&quot;Performing size check after {} pages&quot;, pageAdded);</span>
<span class="nc" id="L174">                ByteArrayOutputStream checkSizeStream = new ByteArrayOutputStream();</span>
<span class="nc" id="L175">                currentDoc.save(checkSizeStream);</span>
<span class="nc" id="L176">                long actualSize = checkSizeStream.size();</span>
<span class="nc" id="L177">                log.debug(&quot;Current document size: {} bytes (max: {} bytes)&quot;, actualSize, maxBytes);</span>

<span class="nc bnc" id="L179" title="All 2 branches missed.">                if (actualSize &gt; maxBytes) {</span>
                    // We exceeded the limit - remove the last page and save
<span class="nc bnc" id="L181" title="All 2 branches missed.">                    if (currentDoc.getNumberOfPages() &gt; 1) {</span>
<span class="nc" id="L182">                        currentDoc.removePage(currentDoc.getNumberOfPages() - 1);</span>
<span class="nc" id="L183">                        pageIndex--; // Process this page again in the next document</span>
<span class="nc" id="L184">                        log.debug(&quot;Size limit exceeded - removed last page&quot;);</span>
                    }

<span class="nc" id="L187">                    log.debug(</span>
                            &quot;Saving document with {} pages as part {}&quot;,
<span class="nc" id="L189">                            currentDoc.getNumberOfPages(),</span>
<span class="nc" id="L190">                            fileIndex);</span>
<span class="nc" id="L191">                    saveDocumentToZip(currentDoc, zipOut, baseFilename, fileIndex++);</span>
<span class="nc" id="L192">                    currentDoc = new PDDocument();</span>
<span class="nc" id="L193">                    pageAdded = 0;</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">                } else if (pageIndex &lt; totalPages - 1) {</span>
                    // We're under the limit, calculate if we might fit more pages
                    // Try to predict how many more similar pages might fit
<span class="nc bnc" id="L197" title="All 4 branches missed.">                    if (actualSize &lt; maxBytes * 0.75 &amp;&amp; pageAdded &gt; 0) {</span>
                        // Rather than using a ratio, look ahead to test actual upcoming pages
<span class="nc" id="L199">                        int pagesToLookAhead = Math.min(5, totalPages - pageIndex - 1);</span>

<span class="nc bnc" id="L201" title="All 2 branches missed.">                        if (pagesToLookAhead &gt; 0) {</span>
<span class="nc" id="L202">                            log.debug(</span>
                                    &quot;Testing {} upcoming pages for potential addition&quot;,
<span class="nc" id="L204">                                    pagesToLookAhead);</span>

                            // Create a temp document with current pages + look-ahead pages
<span class="nc" id="L207">                            PDDocument testDoc = new PDDocument();</span>
                            // First copy existing pages
<span class="nc bnc" id="L209" title="All 2 branches missed.">                            for (int i = 0; i &lt; currentDoc.getNumberOfPages(); i++) {</span>
<span class="nc" id="L210">                                testDoc.addPage(new PDPage(currentDoc.getPage(i).getCOSObject()));</span>
                            }

                            // Try adding look-ahead pages one by one
<span class="nc" id="L214">                            int extraPagesAdded = 0;</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">                            for (int i = 0; i &lt; pagesToLookAhead; i++) {</span>
<span class="nc" id="L216">                                int testPageIndex = pageIndex + 1 + i;</span>
<span class="nc" id="L217">                                PDPage testPage = sourceDocument.getPage(testPageIndex);</span>
<span class="nc" id="L218">                                testDoc.addPage(new PDPage(testPage.getCOSObject()));</span>

                                // Check if we're still under size
<span class="nc" id="L221">                                ByteArrayOutputStream testStream = new ByteArrayOutputStream();</span>
<span class="nc" id="L222">                                testDoc.save(testStream);</span>
<span class="nc" id="L223">                                long testSize = testStream.size();</span>

<span class="nc bnc" id="L225" title="All 2 branches missed.">                                if (testSize &lt;= maxBytes) {</span>
<span class="nc" id="L226">                                    extraPagesAdded++;</span>
<span class="nc" id="L227">                                    log.debug(</span>
                                            &quot;Test: Can add page {} (size would be {})&quot;,
<span class="nc" id="L229">                                            testPageIndex + 1,</span>
<span class="nc" id="L230">                                            testSize);</span>
                                } else {
<span class="nc" id="L232">                                    log.debug(</span>
                                            &quot;Test: Cannot add page {} (size would be {})&quot;,
<span class="nc" id="L234">                                            testPageIndex + 1,</span>
<span class="nc" id="L235">                                            testSize);</span>
<span class="nc" id="L236">                                    break;</span>
                                }
                            }

<span class="nc" id="L240">                            testDoc.close();</span>

                            // Add the pages we verified would fit
<span class="nc bnc" id="L243" title="All 2 branches missed.">                            if (extraPagesAdded &gt; 0) {</span>
<span class="nc" id="L244">                                log.debug(&quot;Adding {} verified pages ahead&quot;, extraPagesAdded);</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">                                for (int i = 0; i &lt; extraPagesAdded; i++) {</span>
<span class="nc" id="L246">                                    int extraPageIndex = pageIndex + 1 + i;</span>
<span class="nc" id="L247">                                    PDPage extraPage = sourceDocument.getPage(extraPageIndex);</span>
<span class="nc" id="L248">                                    currentDoc.addPage(new PDPage(extraPage.getCOSObject()));</span>
                                }
<span class="nc" id="L250">                                pageIndex += extraPagesAdded;</span>
<span class="nc" id="L251">                                pageAdded += extraPagesAdded;</span>
                            }
                        }
                    }
                }
            }
        }

        // Save final document if it has any pages
<span class="nc bnc" id="L260" title="All 2 branches missed.">        if (currentDoc.getNumberOfPages() &gt; 0) {</span>
<span class="nc" id="L261">            log.debug(</span>
                    &quot;Saving final document with {} pages as part {}&quot;,
<span class="nc" id="L263">                    currentDoc.getNumberOfPages(),</span>
<span class="nc" id="L264">                    fileIndex);</span>
<span class="nc" id="L265">            saveDocumentToZip(currentDoc, zipOut, baseFilename, fileIndex++);</span>
        }

<span class="nc" id="L268">        log.debug(&quot;Completed handleSplitBySize with {} document parts created&quot;, fileIndex - 1);</span>
<span class="nc" id="L269">    }</span>

    private void handleSplitByPageCount(
            PDDocument sourceDocument, int pageCount, ZipOutputStream zipOut, String baseFilename)
            throws IOException {
<span class="nc" id="L274">        log.debug(&quot;Starting handleSplitByPageCount with pageCount={}&quot;, pageCount);</span>
<span class="nc" id="L275">        int currentPageCount = 0;</span>
<span class="nc" id="L276">        log.debug(&quot;Creating initial output document&quot;);</span>
<span class="nc" id="L277">        PDDocument currentDoc = null;</span>
        try {
<span class="nc" id="L279">            currentDoc = pdfDocumentFactory.createNewDocumentBasedOnOldDocument(sourceDocument);</span>
<span class="nc" id="L280">            log.debug(&quot;Successfully created initial output document&quot;);</span>
<span class="nc" id="L281">        } catch (Exception e) {</span>
<span class="nc" id="L282">            log.error(&quot;Error creating initial output document&quot;, e);</span>
<span class="nc" id="L283">            throw new IOException(&quot;Failed to create initial output document&quot;, e);</span>
<span class="nc" id="L284">        }</span>

<span class="nc" id="L286">        int fileIndex = 1;</span>
<span class="nc" id="L287">        int pageIndex = 0;</span>
<span class="nc" id="L288">        int totalPages = sourceDocument.getNumberOfPages();</span>
<span class="nc" id="L289">        log.debug(&quot;Processing {} pages&quot;, totalPages);</span>

        try {
<span class="nc bnc" id="L292" title="All 2 branches missed.">            for (PDPage page : sourceDocument.getPages()) {</span>
<span class="nc" id="L293">                pageIndex++;</span>
<span class="nc" id="L294">                log.debug(&quot;Processing page {} of {}&quot;, pageIndex, totalPages);</span>

                try {
<span class="nc" id="L297">                    log.debug(&quot;Adding page {} to current document&quot;, pageIndex);</span>
<span class="nc" id="L298">                    currentDoc.addPage(page);</span>
<span class="nc" id="L299">                    log.debug(&quot;Successfully added page {} to current document&quot;, pageIndex);</span>
<span class="nc" id="L300">                } catch (Exception e) {</span>
<span class="nc" id="L301">                    log.error(&quot;Error adding page {} to current document&quot;, pageIndex, e);</span>
<span class="nc" id="L302">                    throw new IOException(&quot;Failed to add page to document&quot;, e);</span>
<span class="nc" id="L303">                }</span>

<span class="nc" id="L305">                currentPageCount++;</span>
<span class="nc" id="L306">                log.debug(&quot;Current page count: {}/{}&quot;, currentPageCount, pageCount);</span>

<span class="nc bnc" id="L308" title="All 2 branches missed.">                if (currentPageCount == pageCount) {</span>
<span class="nc" id="L309">                    log.debug(</span>
                            &quot;Reached target page count ({}), saving current document as part {}&quot;,
<span class="nc" id="L311">                            pageCount,</span>
<span class="nc" id="L312">                            fileIndex);</span>
                    try {
<span class="nc" id="L314">                        saveDocumentToZip(currentDoc, zipOut, baseFilename, fileIndex++);</span>
<span class="nc" id="L315">                        log.debug(&quot;Successfully saved document part {}&quot;, fileIndex - 1);</span>
<span class="nc" id="L316">                    } catch (Exception e) {</span>
<span class="nc" id="L317">                        log.error(&quot;Error saving document part {}&quot;, fileIndex - 1, e);</span>
<span class="nc" id="L318">                        throw e;</span>
<span class="nc" id="L319">                    }</span>

                    try {
<span class="nc" id="L322">                        log.debug(&quot;Creating new document for next part&quot;);</span>
<span class="nc" id="L323">                        currentDoc = new PDDocument();</span>
<span class="nc" id="L324">                        log.debug(&quot;Successfully created new document&quot;);</span>
<span class="nc" id="L325">                    } catch (Exception e) {</span>
<span class="nc" id="L326">                        log.error(&quot;Error creating new document for next part&quot;, e);</span>
<span class="nc" id="L327">                        throw new IOException(&quot;Failed to create new document&quot;, e);</span>
<span class="nc" id="L328">                    }</span>

<span class="nc" id="L330">                    currentPageCount = 0;</span>
<span class="nc" id="L331">                    log.debug(&quot;Reset current page count to 0&quot;);</span>
                }
<span class="nc" id="L333">            }</span>
<span class="nc" id="L334">        } catch (Exception e) {</span>
<span class="nc" id="L335">            log.error(&quot;Error iterating through pages&quot;, e);</span>
<span class="nc" id="L336">            throw new IOException(&quot;Failed to iterate through pages&quot;, e);</span>
<span class="nc" id="L337">        }</span>

        // Add the last document if it contains any pages
        try {
<span class="nc bnc" id="L341" title="All 2 branches missed.">            if (currentDoc.getPages().getCount() != 0) {</span>
<span class="nc" id="L342">                log.debug(</span>
                        &quot;Saving final document with {} pages as part {}&quot;,
<span class="nc" id="L344">                        currentDoc.getPages().getCount(),</span>
<span class="nc" id="L345">                        fileIndex);</span>
                try {
<span class="nc" id="L347">                    saveDocumentToZip(currentDoc, zipOut, baseFilename, fileIndex++);</span>
<span class="nc" id="L348">                    log.debug(&quot;Successfully saved final document part {}&quot;, fileIndex - 1);</span>
<span class="nc" id="L349">                } catch (Exception e) {</span>
<span class="nc" id="L350">                    log.error(&quot;Error saving final document part {}&quot;, fileIndex - 1, e);</span>
<span class="nc" id="L351">                    throw e;</span>
<span class="nc" id="L352">                }</span>
            } else {
<span class="nc" id="L354">                log.debug(&quot;Final document has no pages, skipping&quot;);</span>
            }
<span class="nc" id="L356">        } catch (Exception e) {</span>
<span class="nc" id="L357">            log.error(&quot;Error checking or saving final document&quot;, e);</span>
<span class="nc" id="L358">            throw new IOException(&quot;Failed to process final document&quot;, e);</span>
        } finally {
            try {
<span class="nc" id="L361">                log.debug(&quot;Closing final document&quot;);</span>
<span class="nc" id="L362">                currentDoc.close();</span>
<span class="nc" id="L363">                log.debug(&quot;Successfully closed final document&quot;);</span>
<span class="nc" id="L364">            } catch (Exception e) {</span>
<span class="nc" id="L365">                log.error(&quot;Error closing final document&quot;, e);</span>
<span class="nc" id="L366">            }</span>
        }

<span class="nc" id="L369">        log.debug(&quot;Completed handleSplitByPageCount with {} document parts created&quot;, fileIndex - 1);</span>
<span class="nc" id="L370">    }</span>

    private void handleSplitByDocCount(
            PDDocument sourceDocument,
            int documentCount,
            ZipOutputStream zipOut,
            String baseFilename)
            throws IOException {
<span class="nc" id="L378">        log.debug(&quot;Starting handleSplitByDocCount with documentCount={}&quot;, documentCount);</span>
<span class="nc" id="L379">        int totalPageCount = sourceDocument.getNumberOfPages();</span>
<span class="nc" id="L380">        log.debug(&quot;Total pages in source document: {}&quot;, totalPageCount);</span>

<span class="nc" id="L382">        int pagesPerDocument = totalPageCount / documentCount;</span>
<span class="nc" id="L383">        int extraPages = totalPageCount % documentCount;</span>
<span class="nc" id="L384">        log.debug(&quot;Pages per document: {}, Extra pages: {}&quot;, pagesPerDocument, extraPages);</span>

<span class="nc" id="L386">        int currentPageIndex = 0;</span>
<span class="nc" id="L387">        int fileIndex = 1;</span>

<span class="nc bnc" id="L389" title="All 2 branches missed.">        for (int i = 0; i &lt; documentCount; i++) {</span>
<span class="nc" id="L390">            log.debug(&quot;Creating document {} of {}&quot;, i + 1, documentCount);</span>
<span class="nc" id="L391">            PDDocument currentDoc = null;</span>
            try {
<span class="nc" id="L393">                currentDoc = pdfDocumentFactory.createNewDocumentBasedOnOldDocument(sourceDocument);</span>
<span class="nc" id="L394">                log.debug(&quot;Successfully created document {} of {}&quot;, i + 1, documentCount);</span>
<span class="nc" id="L395">            } catch (Exception e) {</span>
<span class="nc" id="L396">                log.error(&quot;Error creating document {} of {}&quot;, i + 1, documentCount, e);</span>
<span class="nc" id="L397">                throw new IOException(&quot;Failed to create document&quot;, e);</span>
<span class="nc" id="L398">            }</span>

<span class="nc bnc" id="L400" title="All 2 branches missed.">            int pagesToAdd = pagesPerDocument + (i &lt; extraPages ? 1 : 0);</span>
<span class="nc" id="L401">            log.debug(&quot;Adding {} pages to document {}&quot;, pagesToAdd, i + 1);</span>

<span class="nc bnc" id="L403" title="All 2 branches missed.">            for (int j = 0; j &lt; pagesToAdd; j++) {</span>
                try {
<span class="nc" id="L405">                    log.debug(</span>
                            &quot;Adding page {} (index {}) to document {}&quot;,
<span class="nc" id="L407">                            j + 1,</span>
<span class="nc" id="L408">                            currentPageIndex,</span>
<span class="nc" id="L409">                            i + 1);</span>
<span class="nc" id="L410">                    currentDoc.addPage(sourceDocument.getPage(currentPageIndex));</span>
<span class="nc" id="L411">                    log.debug(&quot;Successfully added page {} to document {}&quot;, j + 1, i + 1);</span>
<span class="nc" id="L412">                    currentPageIndex++;</span>
<span class="nc" id="L413">                } catch (Exception e) {</span>
<span class="nc" id="L414">                    log.error(&quot;Error adding page {} to document {}&quot;, j + 1, i + 1, e);</span>
<span class="nc" id="L415">                    throw new IOException(&quot;Failed to add page to document&quot;, e);</span>
<span class="nc" id="L416">                }</span>
            }

            try {
<span class="nc" id="L420">                log.debug(&quot;Saving document {} with {} pages&quot;, i + 1, pagesToAdd);</span>
<span class="nc" id="L421">                saveDocumentToZip(currentDoc, zipOut, baseFilename, fileIndex++);</span>
<span class="nc" id="L422">                log.debug(&quot;Successfully saved document {}&quot;, i + 1);</span>
<span class="nc" id="L423">            } catch (Exception e) {</span>
<span class="nc" id="L424">                log.error(&quot;Error saving document {}&quot;, i + 1, e);</span>
<span class="nc" id="L425">                throw e;</span>
<span class="nc" id="L426">            }</span>
        }

<span class="nc" id="L429">        log.debug(&quot;Completed handleSplitByDocCount with {} documents created&quot;, documentCount);</span>
<span class="nc" id="L430">    }</span>

    private void saveDocumentToZip(
            PDDocument document, ZipOutputStream zipOut, String baseFilename, int index)
            throws IOException {
<span class="nc" id="L435">        log.debug(&quot;Starting saveDocumentToZip for document part {}&quot;, index);</span>
<span class="nc" id="L436">        ByteArrayOutputStream outStream = new ByteArrayOutputStream();</span>

        try {
<span class="nc" id="L439">            log.debug(&quot;Saving document part {} to byte array&quot;, index);</span>
<span class="nc" id="L440">            document.save(outStream);</span>
<span class="nc" id="L441">            log.debug(&quot;Successfully saved document part {} ({} bytes)&quot;, index, outStream.size());</span>
<span class="nc" id="L442">        } catch (Exception e) {</span>
<span class="nc" id="L443">            log.error(&quot;Error saving document part {} to byte array&quot;, index, e);</span>
<span class="nc" id="L444">            throw new IOException(&quot;Failed to save document to byte array&quot;, e);</span>
<span class="nc" id="L445">        }</span>

        try {
<span class="nc" id="L448">            log.debug(&quot;Closing document part {}&quot;, index);</span>
<span class="nc" id="L449">            document.close();</span>
<span class="nc" id="L450">            log.debug(&quot;Successfully closed document part {}&quot;, index);</span>
<span class="nc" id="L451">        } catch (Exception e) {</span>
<span class="nc" id="L452">            log.error(&quot;Error closing document part {}&quot;, index, e);</span>
            // Continue despite close error
<span class="nc" id="L454">        }</span>

        try {
            // Create a new zip entry
<span class="nc" id="L458">            String entryName = baseFilename + &quot;_&quot; + index + &quot;.pdf&quot;;</span>
<span class="nc" id="L459">            log.debug(&quot;Creating ZIP entry: {}&quot;, entryName);</span>
<span class="nc" id="L460">            ZipEntry zipEntry = new ZipEntry(entryName);</span>
<span class="nc" id="L461">            zipOut.putNextEntry(zipEntry);</span>

<span class="nc" id="L463">            byte[] bytes = outStream.toByteArray();</span>
<span class="nc" id="L464">            log.debug(&quot;Writing {} bytes to ZIP entry&quot;, bytes.length);</span>
<span class="nc" id="L465">            zipOut.write(bytes);</span>

<span class="nc" id="L467">            log.debug(&quot;Closing ZIP entry&quot;);</span>
<span class="nc" id="L468">            zipOut.closeEntry();</span>
<span class="nc" id="L469">            log.debug(&quot;Successfully added document part {} to ZIP&quot;, index);</span>
<span class="nc" id="L470">        } catch (Exception e) {</span>
<span class="nc" id="L471">            log.error(&quot;Error adding document part {} to ZIP&quot;, index, e);</span>
<span class="nc" id="L472">            throw new IOException(&quot;Failed to add document to ZIP file&quot;, e);</span>
<span class="nc" id="L473">        }</span>
<span class="nc" id="L474">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>